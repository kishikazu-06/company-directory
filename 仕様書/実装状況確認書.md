# 実装状況確認書

## 概要
提供された仕様書と現在のソースコード（`src/main/java`, `src/main/resources`）を比較し、実装状況を確認しました。

## 実装状況サマリー

| 機能区分 | 機能名 | 実装状況 | 備考 |
|---|---|---|---|
| **共通** | データ定義（DB） | 済 | 仕様書通り実装されています。 |
| **ログイン** | 認証・セッション | 済 | ログイン、ログアウト、RememberMe実装済み。 |
| | アカウントロック | 済 | 5回失敗でロック、10回失敗でIP遅延の実装あり。 |
| **一覧画面** | 検索・表示 | 済 | キーワード検索、詳細検索、ページネーション実装済み。 |
| | 削除（論理削除） | 済 | 実装済み。 |
| | エクスポート | 済 | Excelエクスポート実装済み。 |
| **追加・編集** | 登録・更新 | 済 | 基本的な登録・更新は実装済み。 |
| | 住所自動入力 | **要確認** | 外部APIではなく内部API(`/api/zip`)を使用しています。 |
| | **排他制御** | **未実装** | **楽観ロック（同時更新防止）の実装が見当たりません。** |
| **アップロード** | Excelインポート | 済 | ドラッグ＆ドロップ、プレビュー、エラー判定など高度に実装されています。 |
| **ゴミ箱** | 削除履歴・復元 | 済 | ゴミ箱一覧、復元機能実装済み。 |
| | 自動パージ | 済 | バッチ処理（`TrashPurgeScheduler`）にて実装済み。 |

---

## 詳細分析

### 1. ログイン画面 (`LoginController`, `AuthService`)
*   **仕様**: ID/PW認証、アカウントロック（15分）、IPベースの遅延（スロットリング）、RememberMe。
*   **現状**: 
    *   `User` エンティティに `lockedUntil`, `failedLoginCount` があり、アカウントロック機構用のフィールドが存在します。
    *   `LoginAttemptService` にてIPアドレスごとの失敗回数をカウントし、遅延 (`getDelaySeconds`) を発生させるロジックが実装されています。
*   **判定**: **実装完了**

### 2. 企業一覧画面 (`CompanyController`)
*   **仕様**: 検索（キーワード・詳細）、一覧表示、ページネーション、削除（論理）、エクスポート。
*   **現状**:
    *   `CompanyController.list` にて `CompanySearchForm` を用いた検索と `Pageable` によるページネーションが実装済み。
    *   論理削除フラグ `isDeleted` の制御も行われています。
    *   Excelエクスポート機能 (`exportExcel`) も実装されています。
*   **判定**: **実装完了**

### 3. 名簿追加・編集画面 (`CompanyController`)
*   **仕様**: 新規登録、編集、住所自動補完、楽観ロック。
*   **現状**:
    *   **住所自動補完**: 仕様書では「外部API（ZipCloud等）」とありますが、現状は自社DB内のマスタ (`ZipMaster`) を検索する内部API (`/api/zip/...`) をJSから呼び出す実装になっています。機能としては満たしていますが、マスタデータのメンテナンスが必要な構成です。
    *   **楽観ロック**: 仕様書にある「保存ボタン押下タイミングで対象データが削除されていないか確認（楽観ロック）」について、`Company` エンティティに `@Version` アノテーションがなく、`CompanyController` でもバージョンチェックを行っていません。
    *   **リスク**: 複数人が同時に同じ企業データを編集した場合、後から保存した人の内容で上書きされる恐れがあります。
*   **判定**: **楽観ロックが未実装**

### 4. アップロード画面 (`ImportController`, `ExcelImportService`)
*   **仕様**: ドラッグ＆ドロップ、検証（Pre-validation）、プレビュー表示、エラー/警告判定、登録実行。
*   **現状**:
    *   一時ファイルへのアップロード、解析、`ImportResultDto` による結果返却など、仕様書に記載された複雑なフローが忠実に実装されています。
    *   「同名企業の警告」「住所の不整合チェック」などの細かい仕様もサービス内にロジックが存在します。
*   **判定**: **実装完了**

### 5. ゴミ箱・自動削除 (`TrashPurgeScheduler`)
*   **仕様**: 論理削除データの閲覧・復元。30日経過で物理削除。
*   **現状**:
    *   `/companies/trash` で一覧表示、`/restore` で復元可能。
    *   `batch` パッケージ内のスケジューラにより、定期的な削除処理が実装されていると思われます。
*   **判定**: **実装完了**

---

## 今後の対応推奨事項

1.  **楽観ロックの実装（優先度：高）**
    *   仕様書に明記されており、データ整合性の観点からも重要です。
    *   `Company` エンティティに `@Version private Integer version;` を追加し、更新処理での排他制御を有効にすることを推奨します。

2.  **住所検索APIの確認（優先度：低）**
    *   現在の内部マスタ方式で運用上問題ないか（郵便番号データの更新運用など）を確認してください。外部API化する場合はJSの修正のみで済みます。
